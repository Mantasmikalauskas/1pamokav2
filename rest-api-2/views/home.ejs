<%- include('partials/header'); -%>

<h2 class="body-title">Autodalių paieška sandėlyje</h2>

<div id="homepage">
  <h3>PAIEŠKA Įveskite detalės kodą, pavadinimą arba gamintoją</h3>
  <form id="searchForm">
    <input type="text" id="searchQuery" placeholder="Pvz.: 10001 arba Audi" required>
    <input type="submit" value="Ieškoti">
  </form>
  <ul id="searchResults"></ul>
</div>

<div id="homepage">
  <h3>Duomenų koregavimas</h3>

  <h4>Pridėti naują</h4>
  <form id="addForm">
    <input type="text" name="id" placeholder="ID (5 skaitmenys)" required>
    <input type="text" name="name" placeholder="Pavadinimas" required>
    <input type="text" name="manufacturer" placeholder="Gamintojas" required>
    <input type="number" step="0.01" name="price" placeholder="Kaina € (pvz. 12.50)" required>
    <input type="number" name="quantity" placeholder="Kiekis" required>
    <input type="submit" value="Pridėti naują">
  </form>

  <h4>Redagavimas, įveskite detalės kodą</h4>
  <form id="editForm">
    <input type="text" name="id" placeholder="ID" required>
    <input type="text" name="name" placeholder="Naujas pavadinimas">
    <input type="text" name="manufacturer" placeholder="Naujas gamintojas">
    <input type="number" step="0.01" name="price" placeholder="Nauja kaina">
    <input type="number" name="quantity" placeholder="Naujas kiekis">
    <input type="submit" value="Redaguoti">
  </form>

  <h4>Ištrinti</h4>
  <form id="deleteForm">
    <input type="text" name="id" placeholder="ID" required>
    <input type="submit" value="Ištrinti">
  </form>
</div>

<div id="homepage">
  <h3>Visų atsargų sąrašas</h3>
  <select id="allItemsDropdown" size="6" style="width:100%; padding:10px;">
    <% (items || []).forEach(function(item){ %>
      <option value="<%= item.id %>">
        <%= item.id %> | <%= item.name %> | <%= item.manufacturer %> | <%= (item.price).toFixed(2).replace('.',',') %> € | kiekis: <%= item.quantity %>
      </option>
    <% }); %>
  </select>
</div>

<script>
// ------- SEARCH -------
document.getElementById("searchForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const q = document.getElementById("searchQuery").value;
  const res = await fetch(`/api/items/search?query=${encodeURIComponent(q)}`);
  const list = document.getElementById("searchResults");
  list.innerHTML = "";
  if (res.ok) {
    const data = await res.json();
    data.forEach(item => {
      const li = document.createElement("li");
      const priceStr = Number(item.price).toFixed(2).replace('.',',');
      li.textContent = `${item.id} | ${item.name} | ${item.manufacturer} | ${priceStr} € | kiekis: ${item.quantity}`;
      list.appendChild(li);
    });
  } else {
    list.innerHTML = "<li>Nerasta</li>";
  }
});

// ------- ADD -------
document.getElementById("addForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const body = Object.fromEntries(new FormData(e.target).entries());
  const res = await fetch("/api/items", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const json = await res.json();
  if (res.ok) {
    alert("Pridėta!");
    window.location.reload();
  } else {
    alert("Klaida pridedant: " + (json.error || res.status));
  }
});

// ------- EDIT -------
document.getElementById("editForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const body = Object.fromEntries(new FormData(e.target).entries());
  const id = body.id;
  delete body.id;
  const res = await fetch("/api/items/" + encodeURIComponent(id), {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const json = await res.json();
  if (res.ok) {
    alert("Atnaujinta!");
    window.location.reload();
  } else {
    alert("Klaida redaguojant: " + (json.error || res.status));
  }
});

// ------- DELETE -------
document.getElementById("deleteForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const id = new FormData(e.target).get("id");
  const res = await fetch("/api/items/" + encodeURIComponent(id), { method: "DELETE" });
  const json = await res.json();
  if (res.ok) {
    alert("Ištrinta!");
    window.location.reload();
  } else {
    alert("Klaida trinant: " + (json.error || res.status));
  }
});
</script>

<%- include('partials/footer'); -%>
